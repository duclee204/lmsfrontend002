<app-notification></app-notification>
<div class="courses-layout">
  <aside *ngIf="isLoggedIn()" class="sidebar" role="complementary" aria-label="Sidebar navigation">
    <app-sidebar-wrapper></app-sidebar-wrapper>
  </aside>
  
  <div class="courses-container" [class.no-sidebar]="!isLoggedIn()">
    <!-- Profile component ho·∫∑c Login/Signup buttons -->
    <div class="profile-header">
      <!-- Hi·ªÉn th·ªã profile n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p -->
      <app-profile 
        *ngIf="isLoggedIn()"
        [username]="username"
        [role]="getDisplayRole(userRole)"
        [avatarUrl]="avatarUrl"
        (profileUpdate)="onProfileUpdate()"
        (logout)="onLogout()">
      </app-profile>
      
      <!-- Hi·ªÉn th·ªã n√∫t login/signup n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p -->
      <div *ngIf="!isLoggedIn()" class="auth-buttons">
        <div class="auth-buttons-desktop">
          <button class="btn btn-outline-primary me-2" (click)="navigateToLogin()">
            <i class="fas fa-sign-in-alt me-1"></i>
            ƒêƒÉng nh·∫≠p
          </button>
          <button class="btn btn-primary" (click)="navigateToSignup()">
            <i class="fas fa-user-plus me-1"></i>
            ƒêƒÉng k√Ω
          </button>
        </div>
        
        <div class="auth-buttons-mobile">
          <button class="btn btn-primary" (click)="navigateToLogin()">
            <i class="fas fa-sign-in-alt me-1"></i>
            ƒêƒÉng nh·∫≠p
          </button>
        </div>
      </div>
    </div>
    
    <div class="header">
    <h1 class="title">
      <span *ngIf="sessionService.isInstructor()">Kh√≥a h·ªçc c·ªßa t√¥i</span>
      <span *ngIf="sessionService.isStudent()">Kh√≥a h·ªçc</span>
      <span *ngIf="sessionService.isAdmin()">T·ªïng quan kh√≥a h·ªçc</span>
      <span *ngIf="!isLoggedIn()">Kh√≥a h·ªçc tr·ª±c tuy·∫øn</span>
      <span *ngIf="isLoggedIn() && !userRole">Danh s√°ch kh√≥a h·ªçc</span>
    </h1>
    <p class="subtitle">
      <span *ngIf="isLoggedIn() && userName">
        <span *ngIf="sessionService.isInstructor()">(Gi·∫£ng vi√™n)</span>
        <span *ngIf="sessionService.isStudent()">(Sinh vi√™n)</span>
        <span *ngIf="sessionService.isAdmin()">(Qu·∫£n tr·ªã vi√™n)</span>
      </span>
      <span *ngIf="!isLoggedIn()">
        Kh√°m ph√° v√† ƒëƒÉng k√Ω c√°c kh√≥a h·ªçc ch·∫•t l∆∞·ª£ng cao
      </span>
    </p>
  </div>

  <!-- Loading state -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>ƒêang t·∫£i kh√≥a h·ªçc...</p>
  </div>

  <!-- Layout for Students: Two sections -->
  <div *ngIf="!loading && (sessionService.isStudent() || !isLoggedIn())" class="student-courses-layout">
    
    <!-- Section 1: My Courses (Enrolled) - ch·ªâ hi·ªÉn th·ªã khi ƒë√£ ƒëƒÉng nh·∫≠p -->
    <div *ngIf="isLoggedIn() && sessionService.isStudent()" class="section">
      <div class="section-header">
        <h2 class="section-title">üìö Kh√≥a h·ªçc c·ªßa t√¥i</h2>
        <span class="course-count">({{ enrolledCourses.length }} kh√≥a h·ªçc)</span>
      </div>
      
      <div *ngIf="enrolledCourses.length === 0" class="empty-state">
        <div class="empty-icon">üéì</div>
        <h3>B·∫°n ch∆∞a ƒëƒÉng k√Ω kh√≥a h·ªçc n√†o</h3>
        <p>H√£y ƒëƒÉng k√Ω m·ªôt kh√≥a h·ªçc t·ª´ danh s√°ch b√™n d∆∞·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu h·ªçc!</p>
      </div>

      <div *ngIf="enrolledCourses.length > 0" class="courses-grid">
        <div *ngFor="let course of enrolledCourses" 
             class="course-card enrolled clickable" 
             (click)="enterCourse(course)"
             [style.cursor]="'pointer'"
             [title]="'B·∫•m ƒë·ªÉ v√†o h·ªçc kh√≥a h·ªçc: ' + getCourseTitle(course)">
          <div class="course-header">
            <div class="course-thumbnail" *ngIf="course.thumbnailUrl">
              <img [src]="getImageUrl(course.thumbnailUrl)" 
                   [alt]="getCourseTitle(course)"
                   class="thumbnail-image">
            </div>
            <div class="course-thumbnail placeholder" *ngIf="!course.thumbnailUrl">
              <div class="placeholder-icon">üìö</div>
            </div>
            
            <div class="course-header-content">
              <h3 class="course-title">{{ getCourseTitle(course) }}</h3>
              <span class="enrollment-status enrolled">‚úÖ ƒê√£ ƒëƒÉng k√Ω</span>
            </div>
          </div>

          <div class="course-info">
            <p class="course-description">{{ getCourseDescription(course) }}</p>
            <div class="course-meta">
              <div class="meta-item" *ngIf="course.enrolledAt">
                <span class="meta-label">Ng√†y ƒëƒÉng k√Ω:</span>
                <span class="meta-value">{{ formatDate(course.enrolledAt) }}</span>
              </div>
              <div class="meta-item" *ngIf="course.categoryName">
                <span class="meta-label">Danh m·ª•c:</span>
                <span class="meta-value">{{ course.categoryName }}</span>
              </div>
            </div>
            
            <!-- Action buttons for enrolled courses -->
            <div class="course-actions">
              <div class="action-buttons">
                <button 
                  class="btn btn-outline-info btn-sm me-2" 
                  (click)="$event.stopPropagation(); viewCourseReviews(course)"
                  title="Xem v√† vi·∫øt ƒë√°nh gi√° cho kh√≥a h·ªçc"
                >
                  <i class="fas fa-star me-1"></i>
                  Vi·∫øt ƒë√°nh gi√°
                </button>
                
                <button 
                  class="btn btn-success" 
                  (click)="$event.stopPropagation(); enterCourse(course)"
                  title="V√†o h·ªçc kh√≥a h·ªçc"
                >
                  <i class="fas fa-play me-2"></i>
                  V√†o h·ªçc
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Section 2: Available Courses (Not Enrolled ho·∫∑c t·∫•t c·∫£ kh√≥a h·ªçc cho guest) -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">
          <span *ngIf="isLoggedIn() && sessionService.isStudent()">üåü Kh√≥a h·ªçc c√≥ s·∫µn</span>
          <span *ngIf="!isLoggedIn()">üåü T·∫•t c·∫£ kh√≥a h·ªçc</span>
        </h2>
        <span class="course-count">({{ availableCourses.length }} kh√≥a h·ªçc)</span>
      </div>

      <div *ngIf="availableCourses.length === 0" class="empty-state">
        <div class="empty-icon">üìñ</div>
        <h3 *ngIf="isLoggedIn()">Kh√¥ng c√≥ kh√≥a h·ªçc n√†o kh√°c</h3>
        <h3 *ngIf="!isLoggedIn()">Hi·ªán ch∆∞a c√≥ kh√≥a h·ªçc n√†o</h3>
        <p *ngIf="isLoggedIn()">Hi·ªán t·∫°i kh√¥ng c√≥ kh√≥a h·ªçc n√†o kh√°c ƒë·ªÉ ƒëƒÉng k√Ω!</p>
        <p *ngIf="!isLoggedIn()">Vui l√≤ng quay l·∫°i sau ƒë·ªÉ xem c√°c kh√≥a h·ªçc m·ªõi!</p>
      </div>

      <div *ngIf="availableCourses.length > 0" class="courses-grid">
        <div *ngFor="let course of paginatedAvailableCourses" 
             class="course-card not-enrolled clickable" 
             (click)="enterCourse(course)"
             [style.cursor]="'pointer'"
             [title]="!isLoggedIn() ? 'Mua ngay kh√≥a h·ªçc: ' + getCourseTitle(course) : (getCoursePrice(course) > 0 ? 'B·∫•m ƒë·ªÉ mua ngay kh√≥a h·ªçc: ' + getCourseTitle(course) : 'B·∫•m ƒë·ªÉ mua ngay kh√≥a h·ªçc mi·ªÖn ph√≠: ' + getCourseTitle(course))">
          <div class="course-header">
            <div class="course-thumbnail" *ngIf="course.thumbnailUrl">
              <img [src]="getImageUrl(course.thumbnailUrl)" 
                   [alt]="getCourseTitle(course)"
                   class="thumbnail-image">
            </div>
            <div class="course-thumbnail placeholder" *ngIf="!course.thumbnailUrl">
              <div class="placeholder-icon">üìö</div>
            </div>
            
            <div class="course-header-content">
              <h3 class="course-title">{{ getCourseTitle(course) }}</h3>
              <span class="enrollment-status not-enrolled">
                <span *ngIf="getCoursePrice(course) > 0">üí∞ C√≥ ph√≠</span>
                <span *ngIf="getCoursePrice(course) === 0">üÜì Mi·ªÖn ph√≠</span>
              </span>
            </div>
          </div>

          <div class="course-info">
            <p class="course-description">{{ getCourseDescription(course) }}</p>
            <div class="course-meta">
              <div class="meta-item" *ngIf="getCoursePrice(course) > 0">
                <span class="meta-label">Gi√°:</span>
                <span class="meta-value price-highlight">{{ formatPrice(getCoursePrice(course)) }}</span>
              </div>
              <div class="meta-item" *ngIf="getCoursePrice(course) === 0">
                <span class="meta-label">Gi√°:</span>
                <span class="meta-value free-tag">MI·ªÑN PH√ç</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">Ng√†y t·∫°o:</span>
                <span class="meta-value">{{ formatDate(getCourseCreatedDate(course)) }}</span>
              </div>
              <div class="meta-item" *ngIf="course.categoryName">
                <span class="meta-label">Danh m·ª•c:</span>
                <span class="meta-value">{{ course.categoryName }}</span>
              </div>
              <div class="meta-item" *ngIf="course.averageRating || course.totalReviews">
                <span class="meta-label">ƒê√°nh gi√°:</span>
                <span class="meta-value rating-info">
                  <span class="stars">
                    <i *ngFor="let star of getStarArray(course.averageRating || 0)" 
                       [class]="star ? 'fas fa-star text-warning' : 'far fa-star text-muted'"></i>
                  </span>
                  <span class="rating-text">
                    {{ (course.averageRating || 0).toFixed(1) }} 
                    ({{ course.totalReviews || 0 }} ƒë√°nh gi√°)
                  </span>
                </span>
              </div>
              <div class="meta-item" *ngIf="!course.averageRating && !course.totalReviews">
                <span class="meta-label">ƒê√°nh gi√°:</span>
                <span class="meta-value text-muted">Ch∆∞a c√≥ ƒë√°nh gi√°</span>
              </div>
            </div>
            
            <!-- Action button -->
            <div class="course-actions">
              <div class="action-buttons">
                <button 
                  class="btn btn-outline-info btn-sm me-2" 
                  (click)="$event.stopPropagation(); viewCourseReviews(course)"
                  title="Xem ƒë√°nh gi√° v√† nh·∫≠n x√©t c·ªßa kh√≥a h·ªçc"
                >
                  <i class="fas fa-star me-1"></i>
                  Xem ƒë√°nh gi√°
                </button>
                
                <button 
                  class="btn" 
                  [ngClass]="!isLoggedIn() ? 'btn-login-required' : (getCoursePrice(course) > 0 ? 'btn-payment' : 'btn-free')"
                  (click)="$event.stopPropagation(); enterCourse(course)"
                >
                  <span *ngIf="!isLoggedIn()">
                    <i class="fas fa-shopping-cart me-2"></i>
                    Mua ngay
                  </span>
                  <span *ngIf="isLoggedIn() && getCoursePrice(course) > 0">
                    <i class="fas fa-credit-card me-2"></i>
                    Mua ngay
                  </span>
                  <span *ngIf="isLoggedIn() && getCoursePrice(course) === 0">
                    <i class="fas fa-plus me-2"></i>
                    Mua ngay
                  </span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <div *ngIf="availableCourses.length > itemsPerPage" class="pagination-container">
        <nav aria-label="Ph√¢n trang kh√≥a h·ªçc">
          <ul class="pagination">
            <!-- Previous Button -->
            <li class="page-item" [class.disabled]="currentPage === 1">
              <button class="page-link" (click)="previousPage()" [disabled]="currentPage === 1">
                <i class="fas fa-chevron-left"></i>
                <span class="d-none d-sm-inline" style="margin-left: 5px;">Tr∆∞·ªõc</span>
              </button>
            </li>

            <!-- Page Numbers -->
            <li *ngFor="let page of getPageNumbers()" 
                class="page-item" 
                [class.active]="page === currentPage">
              <button class="page-link" (click)="goToPage(page)">
                {{ page }}
              </button>
            </li>

            <!-- Next Button -->
            <li class="page-item" [class.disabled]="currentPage === totalPages">
              <button class="page-link" (click)="nextPage()" [disabled]="currentPage === totalPages">
                <span class="d-none d-sm-inline" style="margin-right: 5px;">Sau</span>
                <i class="fas fa-chevron-right"></i>
              </button>
            </li>
          </ul>
        </nav>

        <!-- Page Info -->
        <div class="pagination-info">
          <span>
            Trang {{ currentPage }} / {{ totalPages }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Layout for other roles (existing) -->
  <div *ngIf="!loading && !sessionService.isStudent() && isLoggedIn()">
    <!-- Empty state -->
    <div *ngIf="courses.length === 0 && userRole" class="empty-state">
      <div class="empty-icon">üìö</div>
      <h3 *ngIf="sessionService.isInstructor()">B·∫°n ch∆∞a t·∫°o kh√≥a h·ªçc n√†o</h3>
      <h3 *ngIf="sessionService.isAdmin()">Kh√¥ng c√≥ kh√≥a h·ªçc n√†o</h3>
      <p *ngIf="sessionService.isInstructor()">H√£y t·∫°o kh√≥a h·ªçc ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu gi·∫£ng d·∫°y!</p>
      <p *ngIf="sessionService.isAdmin()">H·ªá th·ªëng ch∆∞a c√≥ kh√≥a h·ªçc n√†o!</p>
    </div>

    <!-- Courses grid -->
    <div *ngIf="courses.length > 0 && userRole" class="courses-grid">
      <div *ngFor="let course of courses" 
           class="course-card clickable" 
           (click)="enterCourse(course)"
           [style.cursor]="'pointer'"
           [title]="'B·∫•m ƒë·ªÉ xem kh√≥a h·ªçc: ' + getCourseTitle(course)">
        <div class="course-header">
          <!-- ·∫¢nh thumbnail kh√≥a h·ªçc -->
          <div class="course-thumbnail" *ngIf="course.thumbnailUrl">
            <img [src]="getImageUrl(course.thumbnailUrl)" 
                 [alt]="getCourseTitle(course)"
                 class="thumbnail-image">
          </div>
          <div class="course-thumbnail placeholder" *ngIf="!course.thumbnailUrl">
            <div class="placeholder-icon">üìö</div>
          </div>
          
          <div class="course-header-content">
            <h3 class="course-title">{{ getCourseTitle(course) }}</h3>
            
            <!-- Tr·∫°ng th√°i kh√≥a h·ªçc cho gi·∫£ng vi√™n -->
            <span *ngIf="sessionService.isInstructor()" 
                  class="course-status" [class]="course.status">
              {{ course.status === 'published' ? 'ƒê√£ xu·∫•t b·∫£n' : 'Nh√°p' }}
            </span>
          </div>
        </div>

        <div class="course-info">
          <p class="course-description">
            {{ getCourseDescription(course) }}
          </p>

          <div class="course-meta">
            <div class="meta-item" *ngIf="getCoursePrice(course)">
              <span class="meta-label">Gi√°:</span>
              <span class="meta-value price">{{ formatPrice(getCoursePrice(course)) }}</span>
            </div>
            
            <div class="meta-item">
              <span class="meta-label">Ng√†y t·∫°o:</span>
              <span class="meta-value">{{ formatDate(getCourseCreatedDate(course)) }}</span>
            </div>

            <div class="meta-item" *ngIf="course.categoryName">
              <span class="meta-label">Danh m·ª•c:</span>
              <span class="meta-value">{{ course.categoryName }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- Payment Modal -->
<app-payment-modal
  [course]="selectedCourseForPayment"
  [isVisible]="isPaymentModalVisible"
  (closeModal)="closePaymentModal()"
  (paymentSuccess)="onPaymentSuccess($event)"
></app-payment-modal>

<!-- Course Reviews Modal -->
<app-course-reviews-modal
  [courseId]="selectedCourseForReviews?.courseId"
  [courseName]="selectedCourseForReviews?.courseName"
  [canWriteReview]="selectedCourseForReviews?.canWriteReview || false"
  [courseInfo]="selectedCourseForReviews?.courseInfo"
  [userLoggedIn]="selectedCourseForReviews?.userLoggedIn || false"
  [isEnrolled]="selectedCourseForReviews?.isEnrolled || false"
  [isVisible]="isReviewsModalVisible"
  (closeModal)="closeReviewsModal()"
  (enrollCourse)="onEnrollFromModal($event)"
></app-course-reviews-modal>

<!-- Login Confirmation Modal -->
<div *ngIf="showLoginConfirmModal" class="modal-overlay" (click)="closeLoginConfirmModal()">
  <div class="confirmation-modal" (click)="$event.stopPropagation()">
    <div class="confirmation-header">
      <h4>
        <i class="fas fa-user-circle me-2"></i>
        B·∫°n c√≥ t√†i kho·∫£n ch∆∞a?
      </h4>
      <button type="button" class="btn-close-confirm" (click)="closeLoginConfirmModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="confirmation-body">
      <p class="text-center mb-4">
        ƒê·ªÉ mua kh√≥a h·ªçc n√†y, b·∫°n c·∫ßn c√≥ t√†i kho·∫£n. H√£y ch·ªçn m·ªôt trong hai t√πy ch·ªçn b√™n d∆∞·ªõi:
      </p>
      
      <div class="confirmation-buttons">
        <button class="btn btn-primary btn-block" (click)="goToLogin()">
          <i class="fas fa-sign-in-alt me-2"></i>
          T√¥i ƒë√£ c√≥ t√†i kho·∫£n - ƒêƒÉng nh·∫≠p
        </button>
        
        <button class="btn btn-success btn-block" (click)="goToRegister()">
          <i class="fas fa-user-plus me-2"></i>
          T√¥i ch∆∞a c√≥ t√†i kho·∫£n - ƒêƒÉng k√Ω
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Notification Component -->
<app-notification></app-notification>
